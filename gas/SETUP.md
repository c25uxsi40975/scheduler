# メールリマインダー・通知 セットアップ手順

## 機能概要

1. **毎週金曜18時のリマインダー**: 翌日（土曜）の外勤がある医員にメール送信
2. **スケジュール確定通知**: 管理者がスケジュールを確定したタイミングで全医員にメール送信
3. **希望入力通知**: 医員が希望を入力・更新したタイミングで管理者にメール送信

## 前提

- 外勤調整データのGoogleスプレッドシートが稼働中であること
- 管理画面で医員のメールアドレスが登録済みであること

## 仕組み

- Google Apps Script（スプレッドシート組み込み）を使用
- **送信元**: スクリプトを設定したGoogleアカウントのGmailアドレス
- **送信者名**: 「外勤調整システム」（スクリプト内の `SENDER_NAME` で変更可能）
- **追加費用**: なし

## ステップ1: 管理画面でメールアドレスを登録

1. Webアプリの管理者画面 → マスタ管理タブを開く
2. 各医員の「📧設定」ボタンからメールアドレスを登録する
3. メールアドレス未設定の医員にはリマインダー・通知は送信されない

## ステップ2: Google Apps Scriptを設定

1. **運用データ用スプレッドシート**（月別シート: 希望_・スケジュール_ がある方）を開く
2. メニューから **「拡張機能」→「Apps Script」** をクリック
3. エディタが開いたら、既存のコードをすべて削除
4. `gas/reminder.gs` の内容をすべてコピーして貼り付ける
5. `MASTER_SPREADSHEET_ID` にマスタ用スプレッドシートのIDを設定（必須）
   ```javascript
   var MASTER_SPREADSHEET_ID = "ここにマスタ用スプレッドシートのIDを貼り付け";
   ```
   ※ スプレッドシートIDはURLの `https://docs.google.com/spreadsheets/d/【ここがID】/edit` の部分
6. `ADMIN_EMAIL` に管理者のメールアドレスを設定（希望入力通知を使う場合）
   ```javascript
   var ADMIN_EMAIL = "admin@example.com";
   ```
   ※ 未設定の場合、希望入力通知は送信されない（他の機能には影響なし）
7. 上部の **「保存」**（💾アイコン）をクリック

## ステップ3: テスト実行

### ドライラン（メール送信なし）

1. Apps Scriptエディタ上部の関数選択で **`dryRunReminder`** を選択
2. **「実行」** をクリック
3. 初回はGoogleアカウントの **権限承認** を求められるので許可する
   - 「このアプリは確認されていません」→「詳細」→「（安全ではないページに）移動」
   - 許可する権限: Gmail送信、スプレッドシート読み取り
4. 下部の「実行ログ」で医員名・外勤先・メールアドレスが正しく表示されるか確認

### 実メール送信テスト

1. 関数選択で **`testSendReminder`** を選択して「実行」
2. 実際にメールが届くことを確認する

> 注意: テスト実行は翌日のスケジュールを参照する。翌日に確定済みの外勤がなければ何も送信されない。

## ステップ4: 定期実行トリガーを設定（リマインダー用）

1. Apps Scriptエディタ左側の **時計アイコン（トリガー）** をクリック
2. 右下の **「＋トリガーを追加」** をクリック
3. 以下の通り設定する:

| 項目 | 設定値 |
|------|--------|
| 実行する関数 | `sendFridayReminder` |
| デプロイ | Head |
| イベントのソース | 時間主導型 |
| 時間ベースのトリガーのタイプ | 週ベースのタイマー |
| 曜日 | 毎週金曜日 |
| 時刻 | 午後6時〜7時 |
| エラー通知設定 | 毎日通知を受け取る（推奨） |

4. **「保存」** をクリック

## ステップ5: Web Appデプロイ（確定通知用）

1. Apps Scriptエディタ右上の **「デプロイ」→「新しいデプロイ」** をクリック
2. 左上の歯車アイコンから **「ウェブアプリ」** を選択
3. 以下の通り設定する:

| 項目 | 設定値 |
|------|--------|
| 説明 | 外勤調整 確定通知 |
| 次のユーザーとして実行 | 自分 |
| アクセスできるユーザー | 全員 |

4. **「デプロイ」** をクリック
5. 表示された **ウェブアプリURL** をコピーする
6. StreamlitアプリのsecretsまたはStreamlit Cloudの設定に以下を追加:
   ```toml
   gas_webapp_url = "https://script.google.com/macros/s/XXXX.../exec"
   ```

## Streamlit secrets 設定項目一覧

```toml
# 必須
spreadsheet_key = "..."
spreadsheet_key_operational = "..."
[gcp_service_account]
# ...

# 確定通知メール機能を使う場合に追加
gas_webapp_url = "https://script.google.com/macros/s/.../exec"
```

## トラブルシューティング

### リマインダーメールが届かない場合

1. Apps Scriptエディタで `dryRunReminder` を実行し、ログを確認
2. 確認ポイント:
   - 「スケジュールシートが見つかりません」→ 対象月のスケジュールが未作成
   - 「翌日の外勤割り当てはありません」→ 確定済みスケジュールに翌日の割り当てがない
   - 「メールアドレス未設定のためスキップ」→ 管理画面でメールアドレスを登録する
   - 「送信失敗」→ メールアドレスの形式を確認する

### 確定通知メールが届かない場合

1. StreamlitのsecretsにGAS Web AppのURLが正しく設定されているか確認
2. Apps Scriptの「実行数」ページでエラーがないか確認
3. Web Appを再デプロイする（コード変更後は毎回再デプロイが必要）

### 希望入力通知メールが届かない場合

1. `ADMIN_EMAIL` が正しく設定されているか確認
2. GASのコードを更新した場合はWeb Appの**再デプロイ**が必要（「デプロイ」→「デプロイを管理」→「新しいバージョン」）
3. Apps Scriptの「実行数」ページでエラーがないか確認

### 送信元アドレスを変更したい場合

送信元はスクリプトの権限を承認したGoogleアカウントに固定される。
変更するには、別のGoogleアカウントでスプレッドシートを開き、Apps Scriptの権限を再承認する。
